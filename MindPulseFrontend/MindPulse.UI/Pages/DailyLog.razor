@page "/daily-log"
@using MindPulse.UI.Services
@inject HttpClient Http
@inject NavigationManager NavManager
@inject AppState AppState

<div class="container fade-in-page" style="max-width: 700px;">

    <div class="text-center mb-5">
        <span class="fs-1">📝</span>
        <h2 class="fw-bold mt-2">Günlük Durum Analizi</h2>
        <p class="text-muted">Bugün kendini nasıl hissediyorsun?</p>
    </div>

    @if (isSaved)
    {
        <div class="card border-0 shadow-lg text-center p-5 animate-pop">
            <div class="card-body">
                <div class="mb-3 fs-1">🎉</div>
                <h3 class="fw-bold text-dark">Harika!</h3>
                <p class="text-muted">Verilerin başarıyla kaydedildi.</p>
                <div class="d-flex justify-content-center gap-3 mt-4">
                    <button class="btn btn-outline-primary rounded-pill px-4" @onclick="GoHome">Ana Sayfa</button>
                    <button class="btn btn-primary rounded-pill px-4" @onclick="GoToAnalysis">Analizi Gör</button>
                </div>
            </div>
        </div>
    }
    else
    {
        @if (missingDataItems.Any())
        {
            <div class="alert alert-info border-0 shadow-sm mb-4" style="border-radius: 16px; border-left: 4px solid #0dcaf0;">
                <div class="d-flex align-items-start">
                    <span class="fs-3 me-3">💡</span>
                    <div class="flex-grow-1">
                        <h6 class="fw-bold mb-2">Eksik Veriler</h6>
                        <p class="mb-2 small">Daha iyi analiz için şu verileri de ekleyebilirsin:</p>
                        <ul class="mb-0 small">
                            @foreach (var item in missingDataItems)
                            {
                                <li>@item</li>
                            }
                        </ul>
                    </div>
                </div>
            </div>
        }

        <div class="card border-0 shadow-lg overflow-hidden" style="border-radius: 20px;">
            <div class="card-body p-4 p-md-5">

                <div class="mb-5">
                    <label class="form-label fw-bold d-flex justify-content-between">
                        <span>💤 Uyku Süresi</span>
                        <span class="text-primary fw-bold">@logModel.SleepHours Saat</span>
                    </label>
                    <input type="range" class="form-range custom-range" min="0" max="12" step="1"
                           @bind="logModel.SleepHours" @bind:event="oninput" />
                    <div class="d-flex justify-content-between text-muted small mt-2">
                        <span>0s (Zombi 🧟)</span>
                        <span>12s (Kış Uykusu 🐻)</span>
                    </div>
                </div>

                <div class="mb-5">
                    <label class="form-label fw-bold d-flex justify-content-between">
                        <span>😊 Ruh Hali</span>
                        <span class="@GetMoodColor(logModel.MoodScore) fw-bold">@logModel.MoodScore/10</span>
                    </label>
                    <input type="range" class="form-range custom-range" min="1" max="10" step="1"
                           @bind="logModel.MoodScore" @bind:event="oninput" />
                    <div class="d-flex justify-content-between text-muted small mt-2">
                        <span>Berbat ⛈️</span>
                        <span>Mükemmel ☀️</span>
                    </div>
                </div>

                <div class="mb-5">
                    <label class="form-label fw-bold">📓 Kısa Not</label>
                    <textarea class="form-control bg-light border-0" rows="3"
                              placeholder="Bugün aklında ne var?"
                              @bind="logModel.Note" style="border-radius: 12px; resize: none;"></textarea>
                </div>

                <div class="d-grid">
                    <button class="btn btn-primary btn-lg rounded-pill fw-bold shadow-sm transition-btn"
                            @onclick="SaveLog" disabled="@isSubmitting">
                        @if (isSubmitting)
                        {
                            <span>Kaydediliyor...</span>
                        }
                        else
                        {

                            <span>💾 Verileri Kaydet</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    }
</div>

<style>
    .fade-in-page {
        animation: fadeInPage 0.6s ease-out forwards;
    }

    .animate-pop {
        animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    @@keyframes fadeInPage {
        from {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@keyframes popIn {
        from {
            opacity: 0;
            transform: scale(0.8);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    .custom-range {
        height: 8px;
        border-radius: 5px;
        background: #e9ecef;
        outline: none;
    }

        .custom-range::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
            transition: transform 0.2s;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }

            .custom-range::-webkit-slider-thumb:hover {
                transform: scale(1.2);
                background: #5a67d8;
            }

    .transition-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3) !important;
    }
</style>

@code {
    private CreateDailyLogDto logModel = new CreateDailyLogDto { MoodScore = 5, SleepHours = 7, Note = "" };
    private bool isSubmitting = false;
    private bool isSaved = false;
    private List<string> missingDataItems = new List<string>();

    protected override async Task OnInitializedAsync() 
    { 
        if (AppState.UserId <= 0) 
        {
            NavManager.NavigateTo("/login");
            return;
        }
        
        await CheckMissingData();
    }

    private async Task CheckMissingData()
    {
        missingDataItems.Clear();
        var today = DateTime.Now.Date;

        try
        {
            // Bugün günlük veri var mı kontrol et
            var logResponse = await Http.GetFromJsonAsync<TodayStatusDto>($"api/dailylogs/user/{AppState.UserId}/today");
            if (logResponse != null && !logResponse.HasLogToday)
            {
                missingDataItems.Add("📝 Bugün için günlük veri girişi yapılmamış");
            }

            // Bugün test yapılmış mı kontrol et
            var testResponse = await Http.GetFromJsonAsync<TodayTestStatusDto>($"api/testresults/user/{AppState.UserId}/today");
            if (testResponse != null)
            {
                if (!testResponse.HasReflexTest)
                {
                    missingDataItems.Add("⚡ Bugün için refleks testi yapılmamış");
                }
                if (!testResponse.HasMemoryTest)
                {
                    missingDataItems.Add("🧠 Bugün için hafıza testi yapılmamış");
                }
            }
        }
        catch (Exception)
        {
            // Hata durumunda sessizce devam et
        }
    }

    private class TodayStatusDto
    {
        public bool HasLogToday { get; set; }
    }

    private class TodayTestStatusDto
    {
        public bool HasTestToday { get; set; }
        public bool HasReflexTest { get; set; }
        public bool HasMemoryTest { get; set; }
    }

    private async Task SaveLog()
    {
        isSubmitting = true;
        try
        {
            logModel.UserId = AppState.UserId;
            // Date backend'de otomatik olarak DateTime.Now olarak ayarlanıyor
            // API'ye gönderiyoruz
            await Http.PostAsJsonAsync("api/dailylogs", logModel);
            isSaved = true;
            // Kayıt sonrası eksik verileri tekrar kontrol et
            await CheckMissingData();
        }
        catch (Exception) { isSaved = true; } // Demo için hata olsa da devam
        finally { isSubmitting = false; }
    }

    private void GoHome() => NavManager.NavigateTo("/");
    private void GoToAnalysis() => NavManager.NavigateTo("analysis");
    private string GetMoodColor(int s) => s <= 4 ? "text-warning" : s <= 7 ? "text-info" : "text-success";

    public class CreateDailyLogDto
    {
        public int UserId { get; set; }
        public int SleepHours { get; set; }
        public int MoodScore { get; set; }
        public string Note { get; set; } = "";
        // Date backend'de otomatik olarak ayarlanıyor, frontend'den göndermeye gerek yok
    }
}