@page "/leaderboard"
@using MindPulse.UI.DTOs
@using MindPulse.UI.Services
@inject HttpClient Http
@inject AppState AppState

<style>
    /* İlk 3 sıraya özel stiller */
    .rank-1 { border-left: 5px solid #FFD700; background-color: #fffae6; } 
    .rank-2 { border-left: 5px solid #C0C0C0; background-color: #f8f9fa; } 
    .rank-3 { border-left: 5px solid #CD7F32; background-color: #fff5f2; }
    
    .medal { font-size: 1.5rem; width: 40px; text-align: center; display: inline-block; }

    /* Sticky Footer (Senin Sıran) */
    .my-rank-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: #2d3748; 
        color: white;
        padding: 15px 0;
        box-shadow: 0 -5px 20px rgba(0,0,0,0.2);
        z-index: 1000;
        animation: slideUp 0.5s ease-out;
    }
    @("@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }")
</style>

<div class="container py-5 mb-5">
    <div class="text-center mb-4">
        <h1 class="fw-bold display-6">🏆 Liderlik Tablosu</h1>
        <p class="text-muted">MindPulse'ın en güçlü zihinleri burada yarışıyor.</p>
        
        <div class="d-inline-block bg-info bg-opacity-10 text-info px-4 py-2 rounded-pill border border-info border-opacity-25">
            <small>ℹ️ <strong>Puan Sistemi:</strong> (En İyi Refleks Skoru) + (En İyi Hafıza Skoru)</small>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="d-flex justify-content-center my-5">
            <div class="spinner-border text-primary" role="status"></div>
        </div>
    }
    else if (leaderboardData == null || !leaderboardData.TopList.Any())
    {
        <div class="alert alert-warning text-center rounded-4 p-4 shadow-sm">
            <h4>Henüz şampiyon yok! 🥇</h4>
            <p>İlk testleri çözerek zirveye yerleşebilirsin.</p>
        </div>
    }
    else
    {
        <div class="row justify-content-center">
            <div class="col-lg-9">
                <div class="card shadow border-0 rounded-4 overflow-hidden">
                    <div class="card-header bg-white p-3 border-bottom">
                        <div class="row fw-bold text-muted small text-uppercase">
                            <div class="col-2 text-center">Sıra</div>
                            <div class="col-4">Kullanıcı</div>
                            <div class="col-3 text-center">Detay</div>
                            <div class="col-3 text-end pe-4">Toplam Puan</div>
                        </div>
                    </div>
                    <div class="list-group list-group-flush">
                        @foreach (var player in leaderboardData.TopList)
                        {
                            bool isMe = (player.Username == currentUsername);
                            string rowClass = isMe ? "bg-primary bg-opacity-10" : "";
                            
                            if (player.Rank == 1) rowClass += " rank-1";
                            else if (player.Rank == 2) rowClass += " rank-2";
                            else if (player.Rank == 3) rowClass += " rank-3";

                            <div class="list-group-item p-3 @rowClass">
                                <div class="row align-items-center">
                                    <div class="col-2 text-center fs-5 fw-bold text-secondary">
                                        @if (player.Rank == 1) { <span class="medal">🥇</span> }
                                        else if (player.Rank == 2) { <span class="medal">🥈</span> }
                                        else if (player.Rank == 3) { <span class="medal">🥉</span> }
                                        else { <span>#@player.Rank</span> }
                                    </div>

                                    <div class="col-4">
                                        <h5 class="mb-0 fw-bold @(isMe ? "text-primary" : "text-dark")">
                                            @player.Username @(isMe ? "(Sen)" : "")
                                        </h5>
                                    </div>

                                    <div class="col-3 text-center">
                                        <small class="d-block text-muted" style="font-size: 0.75rem;">
                                            ⚡ @player.BestReflex.ToString("0") &nbsp;|&nbsp; 🧠 @player.BestMemory.ToString("0")
                                        </small>
                                    </div>

                                    <div class="col-3 text-end pe-3">
                                        <h4 class="mb-0 fw-bold text-primary">@player.TotalScore.ToString("0")</h4>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
</div>

@if (!isLoading && leaderboardData?.UserStats != null && leaderboardData.UserStats.Rank > 10)
{
    <div class="my-rank-bar">
        <div class="container">
            <div class="row justify-content-center">
                <div class="col-lg-9">
                    <div class="d-flex align-items-center justify-content-between px-3">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-warning text-dark fs-5 me-3 rounded-pill px-3">#@leaderboardData.UserStats.Rank</span>
                            <div>
                                <h6 class="mb-0 fw-bold">Senin Sıralaman</h6>
                                <small class="text-white-50">
                                    ⚡ @leaderboardData.UserStats.BestReflex.ToString("0") | 
                                    🧠 @leaderboardData.UserStats.BestMemory.ToString("0")
                                </small>
                            </div>
                        </div>
                        <div class="text-end">
                            <h4 class="mb-0 fw-bold">@leaderboardData.UserStats.TotalScore.ToString("0")</h4>
                            <small class="text-white-50">TOPLAM PUAN</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private LeaderboardResponseDto? leaderboardData;
    private bool isLoading = true;
    private string currentUsername = "";

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;
        try
        {
            currentUsername = AppState.Username ?? "";
            if (AppState.UserId > 0)
            {
                leaderboardData = await Http.GetFromJsonAsync<LeaderboardResponseDto>($"api/testresults/leaderboard/{AppState.UserId}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Hata: " + ex.Message);
        }
        finally
        {
            isLoading = false;
        }
    }
}